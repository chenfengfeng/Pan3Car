# æœ€ç»ˆæ¶æ„æ€»ç»“

**å®Œæˆæ—¥æœŸï¼š** 2025-01-14  
**æ¶æ„ç‰ˆæœ¬ï¼š** V3 - SQLite ç»Ÿä¸€æ¶æ„

---

## ğŸ¯ å®Œæ•´æ¶æ„

### æ•°æ®å±‚ï¼ˆSQLite æ•°æ®åº“ï¼‰

```
pan3_data.db
â”œâ”€â”€ vehicles (è½¦è¾†ç®¡ç†)
â”‚   â”œâ”€â”€ vin (å”¯ä¸€æ ‡è¯†)
â”‚   â”œâ”€â”€ api_token
â”‚   â”œâ”€â”€ internal_state (active/idle/error)
â”‚   â””â”€â”€ next_poll_time (åŠ¨æ€è½®è¯¢æ—¶é—´)
â”‚
â”œâ”€â”€ drives (è¡Œç¨‹è®°å½•)
â”‚   â”œâ”€â”€ start_time / end_time
â”‚   â”œâ”€â”€ start/end GPSåæ ‡ã€ç”µé‡ã€ç»­èˆª
â”‚   â”œâ”€â”€ summary_status (pending/calculating/completed)
â”‚   â”œâ”€â”€ total_distance (å®é™…é‡Œç¨‹)
â”‚   â”œâ”€â”€ consumed_range (æ¶ˆè€—ç»­èˆª)
â”‚   â”œâ”€â”€ max_speed (æœ€é«˜é€Ÿåº¦)
â”‚   â””â”€â”€ avg_speed (å¹³å‡é€Ÿåº¦)
â”‚
â”œâ”€â”€ charges (å……ç”µè®°å½•)
â”‚   â”œâ”€â”€ start_time / end_time
â”‚   â”œâ”€â”€ start/end ç”µé‡ã€ç»­èˆª
â”‚   â”œâ”€â”€ summary_status
â”‚   â”œâ”€â”€ added_range (å¢åŠ ç»­èˆª)
â”‚   â””â”€â”€ data_points_count
â”‚
â”œâ”€â”€ data_points (æ•°æ®ç‚¹è½¨è¿¹)
â”‚   â”œâ”€â”€ æ¯5ç§’ä¸€ä¸ªGPSç‚¹
â”‚   â”œâ”€â”€ é€Ÿåº¦ã€ç”µé‡ã€çŠ¶æ€
â”‚   â”œâ”€â”€ drive_id / charge_id (å…³è”)
â”‚   â””â”€â”€ æ”¯æŒç»˜åˆ¶è½¨è¿¹å›¾
â”‚
â””â”€â”€ charge_tasks (å……ç”µä»»åŠ¡)
    â”œâ”€â”€ mode (time/range)
    â”œâ”€â”€ target_timestamp / target_mile
    â”œâ”€â”€ tima_token / push_token / activity_token
    â””â”€â”€ UNIQUE(vin) çº¦æŸ
```

---

## âš™ï¸ æœåŠ¡å±‚

### 1. ä¸­å¤®è½®è¯¢æœåŠ¡ï¼ˆpolling.service.jsï¼‰

**å¿«è½¦é“ - 5ç§’é«˜é¢‘è½®è¯¢**
- âœ… æè½»é‡çº§æ“ä½œï¼ˆ< 0.1ç§’ï¼‰
- âœ… çŠ¶æ€æ£€æµ‹ + æ•°æ®è®°å½•
- âœ… æ™ºèƒ½è½®è¯¢ï¼ˆactive 5ç§’ / idle 60ç§’ï¼‰
- âœ… å……ç”µä¼˜å…ˆ + è¡Œé©¶ç®¡ç†

**èŒè´£ï¼š**
- æ£€æµ‹è½¦è¾†çŠ¶æ€å˜åŒ–ï¼ˆå¯åŠ¨ã€ç†„ç«ã€å……ç”µï¼‰
- åˆ›å»ºè¡Œç¨‹/å……ç”µè®°å½•
- æ’å…¥æ•°æ®ç‚¹ï¼ˆGPS + é€Ÿåº¦ï¼‰
- æ ‡è®°æ‘˜è¦ä»»åŠ¡ï¼ˆä¸è®¡ç®—ï¼‰

### 2. æ‘˜è¦è®¡ç®—æœåŠ¡ï¼ˆsummary.service.jsï¼‰

**æ…¢è½¦é“ - 30ç§’ç‹¬ç«‹å¾ªç¯**
- âœ… æ‰¹é‡å¤„ç†ï¼ˆæœ€å¤š10ä¸ªä»»åŠ¡ï¼‰
- âœ… SQLèšåˆæŸ¥è¯¢ï¼ˆè¶…é«˜æ•ˆï¼‰
- âœ… è®¡ç®—ç»“æœä¸é˜»å¡è½®è¯¢

**èŒè´£ï¼š**
- æŸ¥è¯¢ pending çŠ¶æ€çš„è®°å½•
- è®¡ç®—å®é™…é‡Œç¨‹ã€æ¶ˆè€—ç»­èˆª
- ç»Ÿè®¡æœ€é«˜/å¹³å‡é€Ÿåº¦
- æ›´æ–°æ‘˜è¦æ•°æ®

### 3. å……ç”µç›‘æ§æœåŠ¡ï¼ˆcharge.controller.jsï¼‰

**Time æ¨¡å¼ï¼š**
- node-schedule å®šæ—¶ä»»åŠ¡
- åˆ°è¾¾æŒ‡å®šæ—¶é—´æ¨é€é€šçŸ¥
- å¯é€‰è‡ªåŠ¨åœæ­¢å……ç”µ

**Range æ¨¡å¼ï¼š**
- 5ç§’è½®è¯¢ç›‘æ§
- è¾¾åˆ°ç›®æ ‡é‡Œç¨‹æ¨é€
- æ”¯æŒ Live Activity

**æ•°æ®åº“å­˜å‚¨ï¼š**
- æ‰€æœ‰ä»»åŠ¡å­˜å‚¨åœ¨ charge_tasks è¡¨
- æœåŠ¡é‡å¯è‡ªåŠ¨æ¢å¤
- æ”¯æŒå¹¶å‘ä»»åŠ¡ç®¡ç†

---

## ğŸ“Š æ•°æ®æµç¨‹

### è¡Œç¨‹è®°å½•æµç¨‹

```
ç”¨æˆ·å¯åŠ¨è½¦è¾†
    â†“
ä¸­å¤®è½®è¯¢æœåŠ¡æ£€æµ‹ keyStatus=1
    â†“
åˆ›å»º drives è®°å½• (summary_status='pending')
    â†“
æ¯5ç§’æ’å…¥ data_point (GPS + é€Ÿåº¦)
    â†“
ç”¨æˆ·ç†„ç«é”è½¦
    â†“
æ›´æ–° drives.end_time (å¿«è½¦é“ï¼š0.1ç§’)
    â†“
æ‘˜è¦æœåŠ¡æ£€æµ‹ pending çŠ¶æ€
    â†“
SQLèšåˆæŸ¥è¯¢è®¡ç®—æ‘˜è¦ (æ…¢è½¦é“ï¼š5ms)
    â†“
æ›´æ–° drives æ‘˜è¦æ•°æ®
```

### å……ç”µè®°å½•æµç¨‹

```
ç”¨æˆ·æ’å…¥å……ç”µæª
    â†“
è½®è¯¢æœåŠ¡æ£€æµ‹ chgStatus=3
    â†“
å¦‚æœæ­£åœ¨è¡Œé©¶ â†’ ç»“æŸè¡Œé©¶ï¼ˆå……ç”µä¼˜å…ˆï¼‰
    â†“
åˆ›å»º charges è®°å½•
    â†“
æ¯5ç§’æ’å…¥ data_point (å……ç”µæ•°æ®)
    â†“
å……ç”µç»“æŸ
    â†“
æ›´æ–° charges.end_time
    â†“
æ‘˜è¦æœåŠ¡è®¡ç®—å¢åŠ ç»­èˆª
```

---

## ğŸš€ æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | æ€§èƒ½ | è¯´æ˜ |
|------|------|------|
| å¿«è½¦é“è½®è¯¢ | 0.1ç§’ | ä¸é˜»å¡ï¼Œé«˜é¢‘ç›‘æ§ |
| æ…¢è½¦é“æ‘˜è¦ | 5ms | SQLèšåˆï¼Œæ‰¹é‡å¤„ç† |
| å……ç”µä»»åŠ¡æŸ¥è¯¢ | <1ms | ç´¢å¼•æŸ¥è¯¢ï¼Œé«˜æ•ˆ |
| æ•°æ®ç‚¹æ’å…¥ | <1ms | æ‰¹é‡å†™å…¥ä¼˜åŒ– |
| è¡Œç¨‹ç»Ÿè®¡ | 50-100x | æ¯”æ—§æ–¹æ¡ˆå¿« |

---

## ğŸ¨ æ¶æ„ä¼˜åŠ¿

### 1. ç»Ÿä¸€æ•°æ®ç®¡ç†
- âœ… æ‰€æœ‰æ•°æ®åœ¨ä¸€ä¸ª SQLite æ–‡ä»¶
- âœ… ç»Ÿä¸€çš„äº‹åŠ¡å’Œç´¢å¼•
- âœ… ä¸€è‡´çš„CRUDæ“ä½œ

### 2. é«˜æ€§èƒ½è®¾è®¡
- âœ… å¿«æ…¢è½¦é“åˆ†ç¦»
- âœ… SQLèšåˆæ›¿ä»£åº”ç”¨å±‚å¾ªç¯
- âœ… æ™ºèƒ½è½®è¯¢é™é¢‘
- âœ… ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

### 3. å¯æ‰©å±•æ€§
- âœ… æ”¯æŒå¤æ‚æŸ¥è¯¢
- âœ… æ”¯æŒç»Ÿè®¡åˆ†æ
- âœ… æ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… åˆ†å¸ƒå¼éƒ¨ç½²å‹å¥½

### 4. å¯ç»´æŠ¤æ€§
- âœ… ä»£ç é‡å‡å°‘ 200+ è¡Œ
- âœ… å…³æ³¨ç‚¹åˆ†ç¦»æ¸…æ™°
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ

---

## ğŸ”§ å·²åºŸå¼ƒåŠŸèƒ½

### startTripPolling æ¥å£
```javascript
// âŒ æ—§ï¼šæ‰‹åŠ¨åˆ›å»º JSON æ–‡ä»¶
fs.writeFileSync('tasks/trip/VIN.json', ...)

// âœ… æ–°ï¼šè‡ªåŠ¨ç”±è½®è¯¢æœåŠ¡ç®¡ç†
// è½®è¯¢æœåŠ¡æ£€æµ‹åˆ°å¯åŠ¨åè‡ªåŠ¨åˆ›å»º drives è®°å½•
```

### æ–‡ä»¶ä»»åŠ¡ç®¡ç†
- âŒ `tasks/range/*.json` - å·²åˆ é™¤
- âŒ `tasks/time/*.json` - å·²åˆ é™¤
- âŒ `tasks/trip/*.json` - å·²åˆ é™¤

**æ›¿ä»£æ–¹æ¡ˆï¼š**
- âœ… `charge_tasks` è¡¨ç®¡ç†å……ç”µä»»åŠ¡
- âœ… `drives` è¡¨ç®¡ç†è¡Œç¨‹è®°å½•
- âœ… `charges` è¡¨ç®¡ç†å……ç”µè®°å½•
- âœ… `data_points` è¡¨å­˜å‚¨è½¨è¿¹æ•°æ®

---

## ğŸ“± ç”¨æˆ·åœºæ™¯

### åœºæ™¯1ï¼šæ—¥å¸¸é€šå‹¤
```
09:00 - APPè§£é”è½¦è¾†
09:00:05 - è½®è¯¢æ£€æµ‹åˆ°è§£é”ï¼ˆ5ç§’è½®è¯¢ï¼‰
09:05 - å¯åŠ¨è½¦è¾†
09:05:05 - åˆ›å»ºè¡Œç¨‹è®°å½•
09:35 - ç†„ç«é”è½¦
09:35:05 - ç»“æŸè¡Œç¨‹ï¼ˆpendingï¼‰
09:35:30 - æ‘˜è¦è®¡ç®—å®Œæˆ
```

### åœºæ™¯2ï¼šå……ç”µç›‘æ§
```
18:00 - å¼€å§‹å……ç”µ
18:00:05 - åˆ›å»ºå……ç”µè®°å½•
18:00:15 - è®¾ç½® range ä»»åŠ¡ï¼ˆç›®æ ‡400kmï¼‰
18:00:20 - æ¯5ç§’è½®è¯¢ç›‘æ§
19:30 - è¾¾åˆ°400km
19:30:05 - æ¨é€é€šçŸ¥ + åˆ é™¤ä»»åŠ¡
```

### åœºæ™¯3ï¼šä¸­é€”åœè½¦
```
10:00 - å¯åŠ¨å‡ºå‘
10:15 - çº¢ç»¿ç¯ç†„ç«ï¼ˆæœªé”è½¦ï¼‰
10:15:05 - ç»§ç»­è®°å½•åŒä¸€è¡Œç¨‹
10:20 - å†æ¬¡å¯åŠ¨
10:45 - é”è½¦ç»“æŸ
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

**åç«¯ï¼š**
- Node.js + Express
- SQLite3 (better-sqlite3)
- node-schedule (å®šæ—¶ä»»åŠ¡)

**æ¶æ„æ¨¡å¼ï¼š**
- ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆå¿«æ…¢è½¦é“ï¼‰
- è½®è¯¢æœåŠ¡ + æ‘˜è¦æœåŠ¡åˆ†ç¦»
- æ•°æ®åº“é©±åŠ¨è®¾è®¡

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- SQL èšåˆæŸ¥è¯¢
- æ™ºèƒ½è½®è¯¢é™é¢‘
- æ‰¹é‡æ•°æ®å¤„ç†
- ç´¢å¼•ä¼˜åŒ–

---

## ğŸ“ˆ æ•°æ®ç»Ÿè®¡èƒ½åŠ›

### å¯æŸ¥è¯¢çš„æ•°æ®
- âœ… æ€»è¡Œç¨‹æ•°ã€æ€»é‡Œç¨‹
- âœ… å¹³å‡æ—¶é€Ÿã€æœ€é«˜æ—¶é€Ÿ
- âœ… æ€»å……ç”µæ¬¡æ•°ã€æ€»å¢åŠ ç»­èˆª
- âœ… æ¯æœˆ/æ¯å¹´çš„æ¶ˆè€—å¯¹æ¯”
- âœ… çƒ­é—¨è¡Œé©¶è·¯çº¿
- âœ… å……ç”µæ•ˆç‡åˆ†æ

### æ”¯æŒçš„åˆ†æ
- âœ… é©¾é©¶è¡Œä¸ºåˆ†æ
- âœ… ç”µæ± å¥åº·åº¦è¯„ä¼°
- âœ… è¡Œé©¶è·¯çº¿ä¼˜åŒ–
- âœ… å……ç”µè®¡åˆ’å»ºè®®

---

## ğŸ‰ æ¶æ„å®Œæˆåº¦

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… è½¦è¾†çŠ¶æ€ç›‘æ§
- âœ… è¡Œç¨‹è‡ªåŠ¨è®°å½•
- âœ… å……ç”µè‡ªåŠ¨è®°å½•
- âœ… å……ç”µä»»åŠ¡ç®¡ç†
- âœ… è½¨è¿¹æ•°æ®é‡‡é›†
- âœ… æ‘˜è¦æ•°æ®è®¡ç®—

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- âœ… å¿«æ…¢è½¦é“åˆ†ç¦»
- âœ… SQLèšåˆæŸ¥è¯¢
- âœ… æ™ºèƒ½è½®è¯¢é™é¢‘
- âœ… æ‰¹é‡å¤„ç†ä¼˜åŒ–

**æ•°æ®ç®¡ç†ï¼š**
- âœ… SQLite ç»Ÿä¸€æ¶æ„
- âœ… äº‹åŠ¡æ”¯æŒ
- âœ… ç´¢å¼•ä¼˜åŒ–
- âœ… è‡ªåŠ¨æ¢å¤

**ä»£ç è´¨é‡ï¼š**
- âœ… æ— ç¼–è¯‘é”™è¯¯
- âœ… æ— linterè­¦å‘Š
- âœ… å®Œå–„çš„æ—¥å¿—
- âœ… æ¸…æ™°çš„æ³¨é‡Š

---

**æ¶æ„ V3 å·²å®Œæˆï¼ğŸš€**

æ‰€æœ‰åŠŸèƒ½å·²è¿ç§»åˆ° SQLite ç»Ÿä¸€æ¶æ„ï¼Œæ€§èƒ½æ˜¾è‘—æå‡ï¼Œä»£ç å¯ç»´æŠ¤æ€§å¤§å¹…æ”¹å–„ã€‚

